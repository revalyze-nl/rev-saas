import PDFDocument from 'pdfkit';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const samplesDir = path.join(__dirname, '../public/samples');

// Ensure samples directory exists
if (!fs.existsSync(samplesDir)) {
  fs.mkdirSync(samplesDir, { recursive: true });
}

// Color palette
const colors = {
  primary: '#8b5cf6',
  secondary: '#a855f7',
  dark: '#1e293b',
  text: '#334155',
  lightText: '#64748b',
  success: '#10b981',
  warning: '#f59e0b',
  danger: '#ef4444',
  white: '#ffffff',
  lightBg: '#f8fafc'
};

// Generate Analysis Report PDF
function generateAnalysisReport() {
  const doc = new PDFDocument({ size: 'A4', margin: 50 });
  const filePath = path.join(samplesDir, 'sample-analysis-report.pdf');
  doc.pipe(fs.createWriteStream(filePath));

  // Header
  doc.rect(0, 0, 595, 120).fill(colors.primary);
  doc.fontSize(28).fillColor(colors.white).text('AI Pricing Analysis Report', 50, 40);
  doc.fontSize(12).text('Acme SaaS - Sample Report', 50, 75);
  doc.fontSize(10).text('Generated by Revalyze', 50, 95);

  // Reset position
  doc.fillColor(colors.text);
  doc.y = 140;

  // Summary Section
  doc.fontSize(18).fillColor(colors.primary).text('Executive Summary', 50, 150);
  doc.moveTo(50, 175).lineTo(545, 175).stroke(colors.primary);
  
  doc.fontSize(11).fillColor(colors.text);
  doc.text(
    'Your pricing strategy positions Acme SaaS in the upper-mid market segment. With an average price point 41% above market median, your value proposition must clearly communicate premium features and support quality to justify the premium.',
    50, 185, { width: 495, lineGap: 4 }
  );

  // Key Metrics
  doc.fontSize(18).fillColor(colors.primary).text('Key Metrics', 50, 260);
  doc.moveTo(50, 285).lineTo(545, 285).stroke(colors.primary);

  const metrics = [
    { label: 'Market Position', value: '+41% vs median' },
    { label: 'Value Score', value: '78/100' },
    { label: 'Competitiveness', value: 'Strong' },
    { label: 'Competitors Analyzed', value: '4' }
  ];

  let metricY = 300;
  metrics.forEach((metric, i) => {
    const x = 50 + (i % 2) * 250;
    if (i === 2) metricY = 340;
    doc.fontSize(10).fillColor(colors.lightText).text(metric.label, x, metricY);
    doc.fontSize(14).fillColor(colors.dark).text(metric.value, x, metricY + 15);
  });

  // Strengths
  doc.fontSize(18).fillColor(colors.success).text('Strengths', 50, 400);
  doc.moveTo(50, 425).lineTo(545, 425).stroke(colors.success);
  
  const strengths = [
    'Strong feature differentiation in the Professional tier',
    'Enterprise plan pricing is competitive at $199',
    'Clear tier progression with logical feature unlocks'
  ];
  
  let y = 435;
  strengths.forEach(item => {
    doc.fontSize(10).fillColor(colors.text).text('+ ' + item, 60, y, { width: 485 });
    y += 20;
  });

  // Weaknesses
  doc.fontSize(18).fillColor(colors.danger).text('Areas for Improvement', 50, 510);
  doc.moveTo(50, 535).lineTo(545, 535).stroke(colors.danger);
  
  const weaknesses = [
    'Starter plan at $29 may face pressure from freemium competitors',
    'No free tier limits acquisition funnel',
    'API access gated to Professional+ may deter developer-focused buyers'
  ];
  
  y = 545;
  weaknesses.forEach(item => {
    doc.fontSize(10).fillColor(colors.text).text('- ' + item, 60, y, { width: 485 });
    y += 20;
  });

  // Suggested Actions
  doc.fontSize(18).fillColor(colors.primary).text('Suggested Actions', 50, 620);
  doc.moveTo(50, 645).lineTo(545, 645).stroke(colors.primary);

  const actions = [
    { title: 'Introduce Annual Billing', impact: 'High', effort: 'Low' },
    { title: 'Add Entry-Level Tier', impact: 'Medium', effort: 'Medium' },
    { title: 'Unlock API at Starter', impact: 'Medium', effort: 'Low' }
  ];

  y = 655;
  actions.forEach(action => {
    doc.fontSize(11).fillColor(colors.dark).text(action.title, 60, y);
    doc.fontSize(9).fillColor(colors.lightText).text(`Impact: ${action.impact} | Effort: ${action.effort}`, 60, y + 14);
    y += 35;
  });

  // Footer
  doc.fontSize(8).fillColor(colors.lightText).text(
    'This is a sample report. Sign up at revalyze.co to generate real analysis reports.',
    50, 780, { width: 495, align: 'center' }
  );

  doc.end();
  console.log('Generated:', filePath);
}

// Generate Simulation Report PDF
function generateSimulationReport() {
  const doc = new PDFDocument({ size: 'A4', margin: 50 });
  const filePath = path.join(samplesDir, 'sample-simulation-report.pdf');
  doc.pipe(fs.createWriteStream(filePath));

  // Header
  doc.rect(0, 0, 595, 120).fill(colors.secondary);
  doc.fontSize(28).fillColor(colors.white).text('Pricing Simulation Report', 50, 40);
  doc.fontSize(12).text('Professional Plan: $79 → $99', 50, 75);
  doc.fontSize(10).text('Generated by Revalyze', 50, 95);

  doc.fillColor(colors.text);

  // Before vs After
  doc.fontSize(18).fillColor(colors.primary).text('Before vs After Summary', 50, 150);
  doc.moveTo(50, 175).lineTo(545, 175).stroke(colors.primary);

  const comparison = [
    { label: 'Current Price', before: '$79/mo', after: '$99/mo', change: '+25%' },
    { label: 'Monthly Revenue', before: '$33.4k', after: '$39.3k', change: '+17.6%' },
    { label: 'Annual Revenue', before: '$401k', after: '$472k', change: '+17.6%' },
    { label: 'Customers', before: '423', after: '388', change: '-8.2%' }
  ];

  let y = 190;
  comparison.forEach(item => {
    doc.fontSize(10).fillColor(colors.lightText).text(item.label, 60, y);
    doc.fontSize(11).fillColor(colors.text).text(item.before, 180, y);
    doc.text('→', 260, y);
    doc.fillColor(colors.dark).text(item.after, 290, y);
    const changeColor = item.change.startsWith('+') ? colors.success : colors.danger;
    doc.fillColor(changeColor).text(item.change, 380, y);
    y += 25;
  });

  // Scenario Analysis
  doc.fontSize(18).fillColor(colors.primary).text('Scenario Analysis', 50, 320);
  doc.moveTo(50, 345).lineTo(545, 345).stroke(colors.primary);

  const scenarios = [
    { name: 'Conservative', arr: '$437k', loss: '-12.5%', sensitivity: 'High' },
    { name: 'Base (Recommended)', arr: '$472k', loss: '-8.2%', sensitivity: 'Moderate' },
    { name: 'Aggressive', arr: '$499k', loss: '-4.8%', sensitivity: 'Low' }
  ];

  y = 360;
  scenarios.forEach((scenario, i) => {
    const isRecommended = scenario.name.includes('Recommended');
    if (isRecommended) {
      doc.rect(50, y - 5, 495, 45).fill('#f0e7ff');
    }
    doc.fontSize(12).fillColor(isRecommended ? colors.primary : colors.dark).text(scenario.name, 60, y);
    doc.fontSize(10).fillColor(colors.lightText).text(`Projected ARR: ${scenario.arr}`, 60, y + 16);
    doc.text(`Customer Loss: ${scenario.loss}`, 220, y + 16);
    doc.text(`Sensitivity: ${scenario.sensitivity}`, 380, y + 16);
    y += 50;
  });

  // AI Recommendation
  doc.fontSize(18).fillColor(colors.primary).text('AI Recommendation', 50, 520);
  doc.moveTo(50, 545).lineTo(545, 545).stroke(colors.primary);

  doc.fontSize(11).fillColor(colors.text);
  doc.text(
    'Proceed with the price increase using a grandfather clause for existing customers. Implement the new pricing for new signups immediately, and transition existing customers after 60-90 days with advance notice.',
    50, 555, { width: 495, lineGap: 4 }
  );

  // Key Factors
  doc.fontSize(14).fillColor(colors.success).text('Key Factors', 50, 620);
  const factors = [
    'Your Professional tier offers more value than competitors',
    'CloudFlow charges $99 for comparable features',
    'Current customers have shown low price sensitivity'
  ];
  y = 640;
  factors.forEach(f => {
    doc.fontSize(10).fillColor(colors.text).text('+ ' + f, 60, y);
    y += 18;
  });

  // Risks
  doc.fontSize(14).fillColor(colors.danger).text('Risks', 300, 620);
  const risks = [
    'Budget-conscious customers may churn',
    'Competitors may try to poach customers',
    'Sales cycle may lengthen'
  ];
  y = 640;
  risks.forEach(r => {
    doc.fontSize(10).fillColor(colors.text).text('! ' + r, 310, y);
    y += 18;
  });

  // Footer
  doc.fontSize(8).fillColor(colors.lightText).text(
    'This is a sample report. Sign up at revalyze.co to generate real simulation reports.',
    50, 780, { width: 495, align: 'center' }
  );

  doc.end();
  console.log('Generated:', filePath);
}

// Run
generateAnalysisReport();
generateSimulationReport();
console.log('Sample PDFs generated successfully!');

