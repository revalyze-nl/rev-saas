# =============================================================================
# Revalyze Staging Docker Compose
# =============================================================================
version: '3.8'

services:
  # ===========================================================================
  # API Backend (Go) - Staging
  # ===========================================================================
  api-staging:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: revalyze-api-staging
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      - APP_ENV=staging
      - APP_PORT=8080
      - MONGO_URI=${MONGO_URI_STAGING}
      - MONGO_DB_NAME=${MONGO_DB_NAME_STAGING}
      - JWT_SECRET=${JWT_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY_TEST}
      - STRIPE_BILLING_SECRET_KEY=${STRIPE_BILLING_SECRET_KEY_TEST}
      - STRIPE_CONNECT_CLIENT_ID=${STRIPE_CONNECT_CLIENT_ID_TEST}
      - STRIPE_CONNECT_REDIRECT_URL=https://staging-api.revalyze.co/api/stripe/connect/callback
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET_TEST}
      - STRIPE_BILLING_SUCCESS_URL=https://staging-app.revalyze.co/settings/billing?success=1
      - STRIPE_BILLING_CANCEL_URL=https://staging-app.revalyze.co/settings/billing?canceled=1
      - STRIPE_CUSTOMER_PORTAL_RETURN_URL=https://staging-app.revalyze.co/settings/billing
      - STRIPE_PRICE_STARTER_ID=${STRIPE_PRICE_STARTER_ID_TEST}
      - STRIPE_PRICE_GROWTH_ID=${STRIPE_PRICE_GROWTH_ID_TEST}
      - STRIPE_PRICE_ENTERPRISE_ID=${STRIPE_PRICE_ENTERPRISE_ID_TEST}
      - APP_PUBLIC_URL=https://staging-app.revalyze.co
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - revalyze-staging-network

  # ===========================================================================
  # Dashboard Frontend (React) - Staging
  # ===========================================================================
  dashboard-staging:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://staging-api.revalyze.co
        - VITE_APP_ENV=staging
    container_name: revalyze-dashboard-staging
    restart: unless-stopped
    ports:
      - "3001:80"
    depends_on:
      - api-staging
    networks:
      - revalyze-staging-network

networks:
  revalyze-staging-network:
    driver: bridge



